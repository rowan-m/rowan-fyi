---
import MinLayout from "@/layouts/MinimumLayout.astro";
---

<MinLayout title="Musaic Box" description="Provide vibe, receive tune.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸµ</text></svg>">
  <style>
    :root {
      font-family: system-ui, sans-serif;
      font-synthesis: none;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    main {
      display: flex;
      flex-flow: column wrap;
      place-items: center;
      gap: 1rem;
    }

    h1 {
      font-size: 1rem;
      margin: 0;
    }
  </style>
  <main>
    <h1>Musaic Box</h1>
    <p class="status">Enter a vibe and generate.</p>
    <label>Vibe <input type="text" name="vibe" /></label>
    <button type="button" name="generate">ğŸ¶ Generate</button>
    <button type="button" name="playpause" disabled>â¯ Play / pause</button>
  </main>
  <script type="module">
    import * as Tone from "https://cdn.jsdelivr.net/npm/tone@15.1.22/+esm";
    let synth, part, session;

    const initialPrompt = `
You are a quick and playful music composer who creates original short tunes based on suggestions from the user.
You provide your output as JSON specifying the note in scientific pitch notation, and its duration in seconds.

Look at the example lines to understand the format for individual notes:
{ "note": "C4", "duration": ".5" }
Plays C in the 4 octave for a half of a second.

{ "note": "D#3", "duration": "1" }
Plays D sharp in the third octave for one second.

{ "note": "Fb2", "duration": ".25" }
Plays F flat in the second octave for a quarter second. Use an "b" to represent the flat symbol.

The note always starts with the letter. Never start with a period character.

Your tune should be approximately 20 notes or fewer.`;

    const testNotes = [
      { note: "C4", duration: ".5" },
      { note: "E4", duration: ".5" },
      { note: "F4", duration: ".5" },
      { note: "G4", duration: ".5" },
      { note: "A4", duration: ".5" },
      { note: "G4", duration: ".5" },
      { note: "E4", duration: ".5" },
      { note: "C4", duration: ".5" },
      { note: "D4", duration: ".25" },
      { note: "E4", duration: ".25" },
      { note: "F4", duration: ".25" },
      { note: "G4", duration: ".25" },
      { note: "A4", duration: ".25" },
      { note: "G4", duration: ".25" },
      { note: "E4", duration: ".25" },
      { note: "C4", duration: ".25" },
      { note: "C5", duration: ".5" },
      { note: "G4", duration: ".5" },
      { note: "C4", duration: ".5" },
    ];
    const schema = {
      type: "object",
      properties: {
        notes: {
          type: "array",
          minItems: 1,
          items: {
            type: "object",
            properties: {
              note: { type: "string" },
              duration: { type: "number" },
            },
            required: ["note", "duration"],
          },
        },
      },
    };

    const statusText = document.querySelector(".status");
    const playPauseButt = document.querySelector('button[name="playpause"]');
    const generateButt = document.querySelector('button[name="generate"]');

    if (!("LanguageModel" in window)) {
      alert("Prompt API is not available in this browser.");
    }

    async function generate(e) {
      const vibe = document.querySelector('input[name="vibe"]').value;
      statusText.textContent = `Generating your "${vibe}" tune...`;
      generateButt.disabled = true;

      try {
        console.log(`Create a melody based on the vibe: ${vibe}`);
          const result = await session.prompt(
            `Create a melody based on the vibe: ${vibe}`,
            { responseConstraint: { schema } }
          );
          const generated = JSON.parse(result);
          console.log(generated.notes);
          const notes = generated.notes;
        // const notes = testNotes;

        const url = new URL(window.location);
        url.searchParams.set("vibe", vibe);
        url.searchParams.set("notes", JSON.stringify(notes));
        window.history.pushState({}, "", url);

        scheduleMelody(notes);
      } catch (error) {
        console.error("Error generating music:", error);
        alert("Failed to generate music. See console for details.");
      }

      statusText.textContent = `Generated! Press play.`;
      playPauseButt.disabled = false;
      generateButt.disabled = false;
    }

    function scheduleMelody(notes) {
      // If a part already exists, stop and dispose of it to avoid overlap
      if (part) {
        part.stop();
        part.dispose();
      }

      let currentTime = 0;
      const partNotes = notes.map((note) => {
        const noteEvent = {
          time: currentTime,
          note: note.note,
          duration: note.duration,
        };
        currentTime += parseFloat(note.duration);
        return noteEvent;
      });

      part = new Tone.Part((time, value) => {
        synth.triggerAttackRelease(value.note, value.duration, time);
      }, partNotes).start(0);

      part.loop = true;
      part.loopEnd = currentTime;
    }

    function playMusic(e) {
      if (Tone.getTransport().state !== "started") {
        Tone.getTransport().start();
      } else {
        Tone.getTransport().stop();
        // Reset transport position to the beginning
        Tone.getTransport().position = 0;
      }
    }

    async function init() {
      synth = new Tone.FMSynth({
        harmonicity: 3.5,
        modulationIndex: 15,
        detune: 2400,
        envelope: {
          attack: 0.001,
          decay: 1.4,
          sustain: 0,
          release: 1.4,
        },
        modulationEnvelope: {
          attack: 0.002,
          decay: 0.8,
          sustain: 0,
          release: 0.8,
        },
      }).toDestination();

      const eq = new Tone.EQ3({
        low: -12,
        mid: -2,
        high: 10,
      }).toDestination();

      const delay = new Tone.PingPongDelay("8n", 0.1).toDestination();
      delay.wet.value = 0.05;

      const reverb = new Tone.Reverb({
        decay: 0.6,
        wet: 0.15,
      }).toDestination();

      synth.chain(eq, delay, reverb);

      const urlParams = new URLSearchParams(window.location.search);
      const vibeParam = urlParams.get("vibe");
      const notesParam = urlParams.get("notes");

      if (vibeParam && notesParam) {
        document.querySelector('input[name="vibe"]').value = vibeParam;
        try {
          const notes = JSON.parse(notesParam);
          scheduleMelody(notes);
          statusText.textContent = `Loaded "${vibeParam}" tune! Press play.`;
          playPauseButt.disabled = false;
        } catch (error) {
          console.error("Error parsing notes from URL:", error);
          alert("Could not load melody from URL. See console for details.");
        }
      }

      console.log(initialPrompt);
      session = await LanguageModel.create({
        initialPrompts: [
          {
            role: "system",
            content: initialPrompt,
          },
        ],
        expectedInputs: [{ type: "text", languages: ["en"] }],
        expectedOutputs: [{ type: "text", languages: ["en"] }],
      });

      document
        .querySelector('button[name="playpause"]')
        .addEventListener("click", playMusic);
      document
        .querySelector('button[name="generate"]')
        .addEventListener("click", generate);
    }

    document.addEventListener("DOMContentLoaded", () => {
      init();
    });
  </script>
</MinLayout>
