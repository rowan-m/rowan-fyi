<!doctype html>
<html lang="en">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <title>JavaScript reduced user-agent</title>
  <style>
    body {
      font-family: sans-serif;
    }

    h1,
    h2 {
      font-size: 1rem;
    }

    code {
      font-weight: bold;
      background: oldlace;
    }

    .did-reduce {
      font-weight: bold;
    }
  </style>
  <h1>JavaScript reduced user-agent</h1>
  <a href="./">⬆ All examples</a>
  <dl>
    <dt>The browser's current <code>navigator.userAgent</code>:</dt>
    <dd><code class="old-ua">[…]</code></dd>
    <dt>Did the code detect a Chrome user-agent and reduce it?</dt>
    <dd class="did-reduce">[…]</dd>
    <dt>Value of <code>navigator.userAgent</code> after the code runs:</dt>
    <dd><code class="new-ua">[…]</code></dd>
  </dl>
  <h2>Code</h2>
  <p>
    <a
      href="https://glitch.com/edit/#!/reduced-ua?path=public%2Fjavascript.html"
      >Edit in Glitch</a
    >
  </p>
  <script src="https://gist.github.com/rowan-m/6f008cb407a81b9d52c00adbb9692929.js"></script>
  <script>
    "use strict";
    if (location.protocol !== "https:" && location.hostname !== "localhost") {
      location.protocol = "https:";
    }

    document.querySelector(".old-ua").textContent = navigator.userAgent;

    // Only match Chrome user-agents we know we can reduce
    // const chromeUAs = new RegExp(
    //   /^Mozilla\/5\.0 \(((?<platform>Lin|Win|Mac|X11; C|X11; L)+[^\)]+)\) /.source +
    //   /AppleWebKit\/537.36 \(KHTML, like Gecko\) /.source +
    //   /Chrome\/(?<major>\d+)[\d\.]+(?<mobile>[ Mobile]*) Safari\/537\.36$/.source
    // );
    const chromeUAs =
      /^Mozilla\/5\.0 \(((?<platform>Lin|Win|Mac|X11; C|X11; L)+[^\)]+)\) AppleWebKit\/537.36 \(KHTML, like Gecko\) Chrome\/(?<major>\d+)[\d\.]+(?<mobile>[ Mobile]*) Safari\/537\.36$/;
    const matched = chromeUAs.exec(navigator.userAgent);

    if (matched) {
      // Map detected platform to reduced value
      const unifiedPlatform = {
        Lin: "Linux; Android 10; K",
        Win: "Windows NT 10.0; Win64; x64",
        Mac: "Macintosh; Intel Mac OS X 10_15_7",
        "X11; C": "CrOS x86_64 14541.0.0",
        "X11; L": "X11; Linux x86_64",
      };
      const reducedUA =
        `Mozilla/5.0 (${unifiedPlatform[matched.groups.platform]}) ` +
        `AppleWebKit/537.36 (KHTML, like Gecko) ` +
        `Chrome/${matched.groups.major}.0.0.0${matched.groups.mobile} Safari/537.36`;
      // Override navigator.userAgent with the reduced string
      Object.defineProperty(navigator, "userAgent", {
        value: reducedUA,
        writable: false,
        configurable: true,
      });
    }

    document.querySelector(".did-reduce").textContent = matched ? "Yes" : "No";
    document.querySelector(".new-ua").textContent = navigator.userAgent;
  </script>
</html>
