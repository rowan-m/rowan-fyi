<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒ±</text></svg>">
<title>Barnsley Ferns</title>
<style>
  * {
    box-sizing: border-box;
  }

  body {
    padding: 0;
    margin: 0;
    overflow: hidden;
    color: whitesmoke;
    background: #222;
    font-family: sans-serif;
    font-size: 0.8rem;
  }

  header {
    padding: 0.4rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: rgba(0, 0, 0, 0.2);
  }

  h1 {
    font-weight: 100;
    font-size: 0.8rem;
  }

  a {
    color: palegoldenrod;
  }
  
  main {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    user-select: none;
    touch-action: none;
    z-index: -10;
    display: flex;
  }

  canvas {
    height: 100%;
    aspect-ratio: 1 / 1.618;
    max-width: 100vw;
    margin: auto;
  }
  
  nav {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
  }
  
  form, nav>section {
    position: relative;
    padding: 0.4rem;
    background-color: rgba(0, 0, 0, 0.2);
    display: flex;
    flex-flow: row wrap;
    justify-content: space-evenly;
    align-items: center;
    align-content: center;
    font-size: 1rem;
  }
  
  nav>section {
    font-size: .8rem;
  }
  
  label {
    font-family: monospace;
  }
  
  form {
    display: flex;
    flex-flow: row nowrap;
    justify-content: center;
    align-items: flex-start;
  }
  
  .p {
    display: flex;
    flex-flow: column nowrap;
  }
  
  .v {
    display: flex;
    flex-flow: row wrap;
    justify-content: space-around;
  }
  
  label {
    display: flex;
  }
  
  input[type="number"] {
    width: 7ch;
  }
  
  input[type="range"] {
    width: 30vw;
  }
</style>
<header>
  <h1>Barnsley Ferns</h1>
</header>
<main>
  <canvas></canvas>
</main>
<nav>
  <form>
    <fieldset class="p">
      <legend>Param</legend>
      <input type="radio" name="val" value="0" checked>
      <input type="radio" name="val" value="1">
      <input type="radio" name="val" value="2">
      <input type="radio" name="val" value="3">
    </fieldset>
    <fieldset class="v">
      <legend>Values</legend>
      <label>a<input type="number" name="a" step=".01"><input type="range" name="r-a" min="-2" max="2" value="0" step=".01"></label>
      <label>b<input type="number" name="b" step=".01"><input type="range" name="r-b" min="-2" max="2" value="0" step=".01"></label>
      <label>c<input type="number" name="c" step=".01"><input type="range" name="r-c" min="-2" max="2" value="0" step=".01"></label>
      <label>d<input type="number" name="d" step=".01"><input type="range" name="r-d" min="-2" max="2" value="0" step=".01"></label>
      <label>e<input type="number" name="e" step=".01"><input type="range" name="r-e" min="-2" max="2" value="0" step=".01"></label>
      <label>f<input type="number" name="f" step=".01"><input type="range" name="r-f" min="-2" max="2" value="0" step=".01"></label>
      <label>p<input type="number" name="p" step=".01"><input type="range" name="r-p" min="0"  max="1" value="0" step=".01"></label>
    </fieldset>
  </form>
  <section>
    <a href="https://twitter.com/rowan_m">ðŸ¦¤ @rowan_m</a>
    <a href="https://mastodon.social/@rowan_m">ðŸ¦£ @rowan_m@mastodon.social</a>
  </section>
</nav>
<script>
  'use strict';
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    location.protocol = 'https:';
  }
  
  /*
   * f(x, y) = |a b| |x| + |e|
   *           |c d| |y|   |f|          
   */  
  const vals = [
    {p:  0.01, a:  0.00, b:  0.00, c:  0.00, d:  0.16, e:  0.00, f:  0.00},
    {p:  0.86, a:  0.85, b:  0.04, c: -0.04, d:  0.85, e:  0.00, f:  1.60},
    {p:  0.93, a:  0.20, b: -0.26, c:  0.23, d:  0.22, e:  0.00, f:  1.60},
    {p:  1.00, a: -0.15, b:  0.28, c:  0.26, d:  0.24, e:  0.00, f:  0.44},
  ];

  let w = 0, h = 0;
  let x = 0, y = 0;
  let maxD = 0;
  
  const maxI = 50000;
  let i = 0;
  
  const cvs = document.querySelector('canvas');
  const ctx = cvs.getContext('2d');
  ctx.globalCompositeOperation = 'difference';
  

  function updateForm(ev) {
    const curVals = vals[ document.querySelector('input[name="val"]:checked').value ];
    for (const param in curVals) {
      document.querySelector(`input[name="${param}"]`).value = parseFloat(curVals[param]);
      document.querySelector(`input[name="r-${param}"]`).value = parseFloat(curVals[param]);
    }
  }
  
  function updateValues(ev) {
    const name = ev.target.name;
    const param  = name.substring(name.length - 1, name.length);
    const curVals = vals[ document.querySelector('input[name="val"]:checked').value ];
    curVals[param] = parseFloat(ev.target.value);
    document.querySelector(`input[name="${param}"]`).value = curVals[param];
    document.querySelector(`input[name="r-${param}"]`).value = curVals[param];
    ctx.clearRect(0, 0, w, h);
    i = 0;
    tick();
  }
  
  function handleResize() {
    w = cvs.getBoundingClientRect().width * window.devicePixelRatio;
    h = cvs.getBoundingClientRect().height * window.devicePixelRatio;
    cvs.width = w;
    cvs.height = h;
    
    i = 0;
    tick();
  }
  
  function update() {
    const r = Math.random();
    const v = vals.find(el => r < el.p);
    const xn = v.a * x + v.b * y + v.e;
    const yn = v.c * x + v.d * y + v.f;
    
    const d = Math.hypot(x - xn, y - yn);
    maxD = Math.max(maxD, d);
    x = xn;
    y = yn;
    
    ctx.fillStyle = `hsl(120deg 50% 50% / .75)`;
    ctx.fillRect(w * (x + 3) / 6, h - h * ((y + 2) / 12.5), .75, .75);
    
    i++;
  }
  
  function tick(t) {
      while(performance.now() - t < 12 && i < maxI) {
        update();
      }
    
      if (i < maxI) {
        window.requestAnimationFrame(tick);
      } else {
      }
    }
  
  updateForm();
  document.querySelector('.p').addEventListener('change', updateForm);
  
  document.querySelector('.v').addEventListener('input', updateValues);
  
  
  handleResize();
  window.addEventListener('resize', handleResize, {passive: true});
</script>