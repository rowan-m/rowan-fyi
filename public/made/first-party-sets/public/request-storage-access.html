<!doctype html>
<html lang="en">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- <link rel="icon" href="data:;base64,iVBORw0KGgo="> -->
  <link
    rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>➕</text></svg>"
  />
  <link rel="stylesheet" href="./water.css" />
  <title>iframe content - First-Party Sets demo</title>
  <style>
    .status {
      font-weight: bold;
    }

    .pass {
      color: darkgreen;
      background: palegreen;
    }

    .fail {
      color: darkred;
      background: lightcoral;
    }

    ol {
      padding-inline-start: 1rem;
    }

    ol > li {
      margin-top: 0.6rem;
    }

    ol > li::marker {
      font-weight: bolder;
      color: var(--text-muted);
    }

    .demos > li {
      padding-left: 3ch;
      text-indent: -3.25ch;
      margin-top: 1rem;
    }
  </style>

  <p>
    🍪 Cookies visible to JavaScript at page load:
    <code class="cookies-load"></code>
  </p>

  <ol>
    <li>
      Check <code>document.hasStorageAccess().then(status => {…})</code> and see
      that <code>status</code> is
      <code class="status storage-access">[…]</code>. If this returns
      <code>true</code> then cross-site cookies will be available, if
      <code>false</code> the page will need to request access.
    </li>

    <li>
      Check
      <code
        >navigator.permissions.query({name: 'storage-access'}).then(res =>
        {…}</code
      >
      and see that <code>res.state</code> is
      <code class="status permission">[…]</code>.
    </li>

    <li>
      <ol type="a">
        <li>
          If <code>granted</code> we can just call
          <code>document.requestStorageAccess().then(res => {…})</code>
          immediately.
        </li>

        <li>
          If <code>prompt</code> we need to put the
          <code>document.requestStorageAccess().then(res => {…})</code> behind a
          user gesture, e.g. clicking a button.<br />
          <button type="button" class="click-for-cookies">
            🍪 Click for cookies</button
          ><br />

          <code>document.requestStorageAccess().then(res => {…})</code> →
          <span class="rsa status">[…]</span>
        </li>
      </ol>
    </li>
    <li>
      Subsequent requests initiated within this frame will now include cookies,
      so if you
      <a href="./request-storage-access.html">🔃 navigate back here again</a>
      you should see the page immediate has storage access and can see the
      cross-site cookie.
    </li>
  </ol>

  <p>
    <strong>Notes:</strong><br />
    💡 If you reload the entire page, you will see that storage access is not
    automatically granted. <code>requestStorageAccess()</code> must be called
    per frame.<br />
    💡 After a successful <code>requestStorageAccess()</code> call, you won't
    see the cross-site cookie in <code>document.cookie</code> immediately
    because the cookie was not sent with the page request.
  </p>
  <script>
    "use strict";
    if (location.protocol !== "https:" && location.hostname !== "localhost") {
      location.protocol = "https:";
    }

    console.log(
      "[" +
        document.location.hostname +
        "] 🍪 Cookies visible to JavaScript at page load: " +
        document.cookie,
    );
    document.querySelector(".cookies-load").textContent = document.cookie;

    // Check if storage access is already enabled
    document.hasStorageAccess().then((access) => {
      console.log(
        "[" +
          document.location.hostname +
          "] 1️⃣ Check if storage access is enabled",
      );
      console.log(
        "[" +
          document.location.hostname +
          "] document.hasStorageAccess().then(access => console.log(access)) → " +
          access,
      );

      document.querySelector(".storage-access").textContent = access
        ? "true"
        : "false";
      document
        .querySelector(".storage-access")
        .classList.add(access ? "pass" : "fail");
    });

    // If storage access is not enabled, we will need to request it.
    // Check the storage access permission to see if that requires a user gesture or can be automatically granted
    navigator.permissions.query({ name: "storage-access" }).then((res) => {
      console.log(
        "[" +
          document.location.hostname +
          "] 2️⃣ Check if the storage-access permission has been granted",
      );
      console.log(
        "[" +
          document.location.hostname +
          "] navigator.permissions.query({name: 'storage-access'}).then(res => console.log(res.state)) → " +
          res.state,
      );

      // Permission has already been granted
      if (res.state === "granted") {
        document.querySelector(".permission").textContent = "granted";
        document.querySelector(".permission").classList.add("pass");

        // Request storage access without any user gesture
        if ("requestStorageAccess" in document) {
          document.requestStorageAccess().then(
            (res) => {
              console.log(
                "[" +
                  document.location.hostname +
                  "] 3️⃣🅰 Storage-access permission granted, immediately request storage access.",
              );
              console.log(
                "[" +
                  document.location.hostname +
                  "] document.requestStorageAccess().then(res => {…}) → success",
              );
              document.querySelector(".rsa").textContent = "success";
              document.querySelector(".rsa").classList.add("pass");
            },
            (err) => {
              console.log(
                "[" +
                  document.location.hostname +
                  "] 3️⃣🅰 Storage-access permission granted, immediately request storage access.",
              );
              console.log(
                "[" +
                  document.location.hostname +
                  "] document.requestStorageAccess().then(res => {…}, err => {…}) → ERROR:",
                err,
              );
            },
          );
        }
      } else if (res.state === "prompt") {
        document.querySelector(".permission").textContent = "prompt";
        document.querySelector(".permission").classList.add("fail");
      }
    });

    document
      .querySelector(".click-for-cookies")
      .addEventListener("click", () => {
        if ("requestStorageAccess" in document) {
          document.requestStorageAccess().then(
            (res) => {
              console.log(
                "[" +
                  document.location.hostname +
                  "] 3️⃣🅱 Request storage access after user gesture, e.g. this button click.",
              );
              console.log(
                "[" +
                  document.location.hostname +
                  "] document.requestStorageAccess().then(res => {…}) → success",
              );
              document.querySelector(".rsa").textContent = "success";
              document.querySelector(".rsa").classList.add("pass");
            },
            (err) => {
              console.log(
                "[" +
                  document.location.hostname +
                  "] 3️⃣🅱 Request storage access after user gesture, e.g. this button click.",
              );
              console.log(
                "[" +
                  document.location.hostname +
                  "] document.requestStorageAccess().then(res => {…}, err => {…}) → ERROR:",
                err,
              );
            },
          );
        }
      });
  </script>
</html>
